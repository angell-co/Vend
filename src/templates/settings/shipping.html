{% extends "vend/_layouts/settings" %}

{% import "_includes/forms" as forms %}

{% from "vend/_includes/macros.html" import configWarning %}

{% block content %}

    {% if oauthAppMissing %}
        <p>You are not connected to Vend, <a href="{{ url('oauthclient/apps') }}">please connect to your Vend store</a> first.</p>
    {% elseif not oauthToken or not oauthProvider %}
        <p>Your OAuth app needs a token generating, you can do this <a href="{{ url('oauthclient/apps') }}">here</a>.</p>
    {% endif %}

    {% if not oauthAppMissing and oauthToken and oauthProvider %}
        <h2>{{ "Shipping Settings"|t('vend') }}</h2>

        {{ forms.selectField({
            label: 'Shipping Product Type'|t,
            instructions: 'Choose the Vend Product Type that contains your shipping products.'|t,
            id: 'vendShippingProductType',
            name: 'vendShippingProductType',
            options: vendProductTypes,
            required: true,
        }) }}
        <div id="vendShippingProductType-spinner" class="spinner left hidden"></div>


        <form action="" method="post" accept-charset="UTF-8" data-saveshortcut id="shippingMapForm" class="hidden">
            <input type="hidden" name="action" value="vend/settings/save-shipping">
            {{ redirectInput('vend/settings/shipping') }}
            {{ csrfInput() }}

            <div id="shippingMapFields">
                {% for shippingRule in shippingRules %}
                    {{ forms.selectField({
                        label: shippingRule.name,
                        instructions: 'Choose the Vend Shipping Product you want to match this shipping rule to.'|t,
                        id: 'shippingMap-'~shippingRule.id,
                        name: 'shippingMap['~shippingRule.id~']',
                        value: settings.shippingMap and settings.shippingMap[shippingRule.id] is defined ? settings.shippingMap[shippingRule.id] : null,
                    }) }}
                {% endfor %}
            </div>

            <input type="submit" class="btn submit" value="{{ 'Save'|t('vend') }}">
        </form>
    {% endif %}
{% endblock %}


{% js %}
    var $productTypeInput = $("#vendShippingProductType"),
        $spinner = $('#vendShippingProductType-spinner'),
        $shippingMapForm = $('shippingMapForm'),
        $shippingMapFields = $('shippingMapFields');

    $productTypeInput.change(function(e) {
        var typeId = $(this).val();

        $spinner.removeClass('hidden');

        var data = {
            'typeId': typeId
        };
        Craft.postActionRequest('vend/settings/get-shipping-products', data, function(response, textStatus) {
            $spinner.addClass('hidden');
            if (textStatus === 'success') {

                $.each($shippingMapFields.find('.field'), function(index, $field) {
                    // TODO - fix this here
                    $.each(response.products, function(index2, product) {
                        $('<option value="'+product.value+'">'+product.label+'</option>').appendTo($field.find('select'));
                    });
                });

                $shippingMapForm.removeClass('hidden');
            }
        });

    });
{% endjs %}
